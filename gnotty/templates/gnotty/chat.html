<!doctype html>
<html lang="en">
<head>

<head>
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/json2/20110223/json2.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/socket.io/0.8.2/socket.io.min.js"></script>
<script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
<script>

$(function() {

    var started = false;

    $('form').submit(function() {
        var value = $('#message').val();
        if (value) {
            if (!started) {
                start(value);
            } else {
                socket.emit('message', value);
            }
        }
        $('#message').val('').focus();
        return false;
    });

    $('#leave').click(function() {
        location.reload();
    });

    var start = function(nickname) {

        started = true;
        socket = io.connect();
        socket.on('connect', function() {
            socket.emit('start', 'localhost', 6667, '#test', nickname);
            $('.hidden').show();
            $('#submit').val('Send');
        });

        socket.on('nicknames', function(nicknames) {
            $('#nicknames').html('')
            $.each(nicknames.sort(), function(i, nickname) {
                $('#nicknames-template').tmpl({
                    nickname: nickname
                }).appendTo('#nicknames');
            });
        });

        var time = function() {
            var d = new Date();
            var parts = [d.getHours(), d.getMinutes(), d.getSeconds()];
            return $.map(parts, function(s) {
                return (String(s).length == 1 ? '0' : '') + s;
            }).join(':');
        };

        socket.on('message', function(nickname, message) {
            $('#messages-template').tmpl({
                time: time(),
                nickname: nickname,
                message: message
            }).appendTo('#messages');
            window.scrollBy(0, 10000);
        });

    };

    $('#message').val('').focus();

});

</script>
<style>

* {font-size:16px; font-family:sans-serif;}
body {margin:20px 0 0 0;}
#main {padding-bottom:100px;}

form {position:fixed; bottom:0; background:#ccc; width:100%;
      border-top:1px solid #999;}
input {border:1px solid #999; padding:10px; border-radius:5px;}
#message {width:600px; margin:20px 0 20px 20px;}
#submit, #leave {cursor:pointer; margin-left:10px; padding:10px 30px;}

ul {margin:0; padding:0; list-style-type:none;}
h1, p, li {margin:10px 20px;}

#nicknames {position:fixed; right:0; top:0; bottom:0; width:200px;
            background:#eee; overflow:hidden; border-left:1px solid #ccc;}

.hidden {display: none;}

</style>
</head>

<body>

<script id="messages-template" type="text/x-jquery-tmpl">
    <li>(${time}) ${nickname}: ${message}</li>
</script>
<script id="nicknames-template" type="text/x-jquery-tmpl">
    <li>${nickname}</li>
</script>

<div id="main">
<ul id="messages"></ul>
<ul id="nicknames" class="hidden"></ul>
</div>

<form>
    <input type="text" id="message" name="message">
    <input type="submit" id="submit" value="Join">
    <input type="button" id="leave" value="Leave" class="hidden">
</form>

</body>
</html>
